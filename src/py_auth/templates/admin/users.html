{% extends "base.html" %}

{% block title %}ユーザー管理 - PyAuth{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users"></i> ユーザー管理</h2>
    <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> 新規ユーザー作成
    </a>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ユーザー名</th>
                        <th>権限</th>
                        <th>2FA</th>
                        <th>Passkey</th>
                        <th>作成日</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.is_first_login %}
                                <small class="badge bg-warning ms-1">初回ログイン</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_super_admin %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-crown"></i> スーパー管理者
                                </span>
                            {% elif user.is_admin %}
                                <span class="badge bg-primary">
                                    <i class="fas fa-user-shield"></i> 管理者
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-user"></i> 一般ユーザー
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.is_totp_enabled %}
                                <span class="text-success"><i class="fas fa-check"></i> 有効</span>
                            {% else %}
                                <span class="text-muted"><i class="fas fa-times"></i> 無効</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ user.passkeys|length }}個</span>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" 
                                   class="btn btn-outline-info" title="詳細">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if user.id != session.user_id %}
                                    <!-- パスワードリセット -->
                                    <button type="button" class="btn btn-outline-warning" 
                                            onclick="resetPassword({{ user.id }}, '{{ user.username }}')" 
                                            title="パスワードリセット">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    
                                    <!-- 管理者権限切り替え（スーパー管理者のみ、かつ対象がスーパー管理者でない場合） -->
                                    {% set current_user = users|selectattr('id', 'equalto', session.user_id)|first %}
                                    {% if current_user and current_user.is_super_admin and not user.is_super_admin %}
                                        <button type="button" 
                                                class="btn btn-outline-{{ 'secondary' if user.is_admin else 'primary' }}" 
                                                onclick="toggleAdmin({{ user.id }}, '{{ user.username }}', {{ user.is_admin|lower }})" 
                                                title="{{ '管理者権限を削除' if user.is_admin else '管理者権限を付与' }}">
                                            <i class="fas fa-{{ 'user-minus' if user.is_admin else 'user-plus' }}"></i>
                                        </button>
                                    {% endif %}
                                    
                                    <!-- ユーザー削除（スーパー管理者以外） -->
                                    {% if not user.is_super_admin %}
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteUser({{ user.id }}, '{{ user.username }}')" 
                                                title="削除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-light text-dark">自分</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- パスワードリセット結果モーダル -->
<div class="modal fade" id="passwordResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">パスワードリセット完了</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="resetMessage"></p>
                <div class="alert alert-warning">
                    <strong>新しい仮パスワード:</strong>
                    <code id="newPassword" class="user-select-all"></code>
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyPassword()">
                        <i class="fas fa-copy"></i> コピー
                    </button>
                </div>
                <p><small class="text-muted">このパスワードを安全に伝達してください。ユーザーは初回ログイン時にパスワード変更が必要です。</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function resetPassword(userId, username) {
    if (!confirm(`ユーザー「${username}」のパスワードをリセットしますか？\n\n・新しい仮パスワードが生成されます\n・2FAとPasskeyは無効化されます\n・初回ログイン状態になります`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('resetMessage').textContent = `ユーザー「${username}」のパスワードをリセットしました。`;
            document.getElementById('newPassword').textContent = result.new_password;
            
            const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
            modal.show();
            
            // ページをリロードして状態を更新
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            alert('エラー: ' + result.error);
        }
    } catch (error) {
        console.error('パスワードリセットエラー:', error);
        alert('パスワードリセットに失敗しました');
    }
}

async function toggleAdmin(userId, username, isCurrentlyAdmin) {
    const action = isCurrentlyAdmin ? '削除' : '付与';
    if (!confirm(`ユーザー「${username}」の管理者権限を${action}しますか？`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('エラー: ' + result.error);
        }
    } catch (error) {
        console.error('権限変更エラー:', error);
        alert('権限変更に失敗しました');
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`ユーザー「${username}」を削除しますか？\n\nこの操作は取り消せません。`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/${userId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('エラー: ' + result.error);
        }
    } catch (error) {
        console.error('ユーザー削除エラー:', error);
        alert('ユーザー削除に失敗しました');
    }
}

function copyPassword() {
    const passwordElement = document.getElementById('newPassword');
    const password = passwordElement.textContent;
    
    navigator.clipboard.writeText(password).then(() => {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> コピー済み';
        btn.classList.add('text-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('text-success');
        }, 2000);
    });
}
</script>
{% endblock %}