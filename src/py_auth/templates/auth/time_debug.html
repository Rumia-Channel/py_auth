{% extends "base.html" %}

{% block title %}時刻デバッグ情報 - PyAuth{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> 時刻同期デバッグ情報</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>時刻情報</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>ローカル時刻</td>
                                <td id="local-time">-</td>
                            </tr>
                            <tr>
                                <td>同期時刻</td>
                                <td id="sync-time">-</td>
                            </tr>
                            <tr>
                                <td>オフセット</td>
                                <td id="offset">-</td>
                            </tr>
                            <tr>
                                <td>最終同期</td>
                                <td id="last-sync">-</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>TOTP情報</h6>
                        <div id="totp-info">
                            {% if current_user and current_user.totp_secret %}
                                <div class="mb-2">
                                    <strong>現在のコード:</strong>
                                    <span class="badge bg-primary font-monospace fs-6" id="current-totp">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>残り時間:</strong>
                                    <span id="time-remaining">-</span>秒
                                </div>
                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar" id="time-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            {% else %}
                                <p class="text-muted">2FAが設定されていません</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="refreshTimeInfo()">
                        <i class="fas fa-sync"></i> 更新
                    </button>
                    <button class="btn btn-outline-secondary" onclick="syncNow()">
                        <i class="fas fa-clock"></i> 手動同期
                    </button>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> NTP同期について</h6>
                        <ul class="mb-0 small">
                            <li>ntp.nict.jp から時刻を取得します</li>
                            <li>1時間ごとに自動同期されます</li>
                            <li>TOTP認証は±90秒の範囲で有効です</li>
                            <li>オフセットが大きい場合は手動同期を実行してください</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let timeInterval;

function refreshTimeInfo() {
    fetch('/api/time-debug')
        .then(response => response.json())
        .then(data => {
            document.getElementById('local-time').textContent = new Date(data.local_time).toLocaleString();
            document.getElementById('sync-time').textContent = new Date(data.sync_time).toLocaleString();
            document.getElementById('offset').textContent = data.offset.toFixed(3) + ' 秒';
            document.getElementById('last-sync').textContent = data.last_sync ? new Date(data.last_sync).toLocaleString() : '未同期';
        })
        .catch(error => {
            console.error('時刻情報取得エラー:', error);
        });
}

function syncNow() {
    fetch('/api/ntp-sync', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('NTP同期が完了しました');
                refreshTimeInfo();
            } else {
                alert('NTP同期に失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            console.error('NTP同期エラー:', error);
            alert('NTP同期に失敗しました');
        });
}

function updateTOTP() {
    {% if current_user and current_user.totp_secret %}
    fetch('/api/totp-current')
        .then(response => response.json())
        .then(data => {
            document.getElementById('current-totp').textContent = data.code;
            document.getElementById('time-remaining').textContent = data.remaining;
            
            const progress = (30 - data.remaining) / 30 * 100;
            document.getElementById('time-progress').style.width = progress + '%';
            
            if (data.remaining <= 5) {
                document.getElementById('time-progress').className = 'progress-bar bg-danger';
            } else if (data.remaining <= 10) {
                document.getElementById('time-progress').className = 'progress-bar bg-warning';
            } else {
                document.getElementById('time-progress').className = 'progress-bar bg-success';
            }
        })
        .catch(error => {
            console.error('TOTP情報取得エラー:', error);
        });
    {% endif %}
}

document.addEventListener('DOMContentLoaded', function() {
    refreshTimeInfo();
    updateTOTP();
    
    // 1秒ごとに更新
    timeInterval = setInterval(() => {
        updateTOTP();
    }, 1000);
    
    // 30秒ごとに時刻情報更新
    setInterval(refreshTimeInfo, 30000);
});

// ページを離れる時にインターバルをクリア
window.addEventListener('beforeunload', function() {
    if (timeInterval) {
        clearInterval(timeInterval);
    }
});
</script>
{% endblock %}